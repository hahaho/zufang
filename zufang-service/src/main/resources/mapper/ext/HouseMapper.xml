<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.apass.zufang.mapper.zfang.HouseMapper" >
	<!-- 初始es分页查询条件 -->
    <sql id="QueryConditionSql">
        <where>
			<if test="houseCode!=null and houseCode!=''"> AND code = #{houseCode} </if>
			<if test="listTimeStr=='yes'">  AND CURRENT_TIMESTAMP > list_time </if>
            <if test="apartmentId!=null and apartmentId!=''"> AND apartment_id = #{apartmentId} </if>
            <if test="type!=null and type!=''"> AND type = #{type} </if>
            <if test="title!=null and title!=''"> AND title = #{title} </if>
            <if test="isDelete!=null and isDelete!=''"> AND is_delete = #{isDelete} </if>
            <if test="status!=null">
                AND status in
                <foreach item="item" index="index" collection="status" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </sql>
    
    <!-- 房屋信息管理中心 -->
    <sql id="QueryHouseConditionSql">
       <where>
	        <if test="apartmentName!=null and apartmentName!=''">
	            AND apart.name LIKE '%${apartmentName}%'
	        </if>
	        <if test="title!=null and title!=''"> 
	            AND house.title LIKE '%${title}%'
	        </if>
	        <if test="code!=null and code!=''"> 
	            AND house.code = #{code} 
	        </if>
	        <if test="city!=null and city!=''">
	            AND location.city = #{city} 
	        </if>
	        <if test="district!=null and district!=''">
	            AND location.district = #{district} 
	        </if>
	        <if test="street!=null and street!=''">
	            AND location.street = #{street} 
	        </if>
	        <if test="isDelete!=null and isDelete!=''"> 
	            AND house.is_delete = #{isDelete} AND apart.is_delete = #{isDelete} AND location.is_delete = #{isDelete}
	        </if>
	        <if test="status!=null">
	            AND status in
	            <foreach item="item" index="index" collection="status" open="(" separator="," close=")">
	                #{item}
	            </foreach>
	        </if>
        </where>
    </sql>
    
	<!-- 初始化es查询 -->
    <select id="getHouseList" resultMap="BaseResultMap" 
        parameterType="com.apass.zufang.domain.dto.HouseQueryParams">
        SELECT 
            <include refid="Base_Column_List" />
        FROM t_zfang_house
            <include refid="QueryConditionSql" />
        <![CDATA[ 
        ORDER BY created_time DESC
        ]]>
        <if test="startRecordIndex != null">
            <include refid="PAGINATION.MYSQL_PAGINATION" />
        </if>
    </select>
    <!-- 分页查询数量 -->
    <select id ="getHouseListCount" resultType="java.lang.Integer"
       parameterType="com.apass.zufang.domain.dto.HouseQueryParams">
        SELECT COUNT(*) FROM t_zfang_house
        <include refid="QueryConditionSql" />
    </select>
    
    <!-- 房源信息管理 -->
    <select id="getHouseLists" resultType="com.apass.zufang.domain.vo.HouseBagVo" 
        parameterType="com.apass.zufang.domain.dto.HouseQueryParams">
        SELECT 
            apart.id apartId,
            apart.name apartName,
            house.id houseId,
            house.code houseCode,
            house.title title,
            house.status status,
            house.community_name communityName,
            house.room room,
            house.hall hall,
            house.wei  wei,
            house.rent_amt rentAmt,
            house.zujin_type zujinType
        FROM t_zfang_house house 
        left join t_zfang_apartment apart on house.apartment_id = apart.id
        left join t_zfang_house_location location on house.id = location.house_id
        <include refid="QueryHouseConditionSql" />
        ORDER BY house.created_time DESC
        <if test="startRecordIndex != null">
            <include refid="PAGINATION.MYSQL_PAGINATION" />
        </if>
    </select>
    <!-- 房源信息管理分页查询数量 -->
    <select id ="getHouseListsCount" resultType="java.lang.Integer"
       parameterType="com.apass.zufang.domain.dto.HouseQueryParams">
        SELECT 
            apart.id apartId,
            apart.name apartName,
            house.id houseId,
            house.code houseCode,
            house.title title,
            house.status status,
            house.community_name communityName,
            house.room room,
            house.hall hall,
            house.wei  wei,
            house.rent_amt rentAmt,
            house.zujin_type zujinType
        FROM t_zfang_house house 
        left join t_zfang_apartment apart on house.apartment_id = apart.id
        left join t_zfang_house_location location on house.id = location.house_id
        <include refid="QueryHouseConditionSql" />
        ORDER BY house.created_time DESC
    </select>
    
    <!--品牌公寓热门房源列表查询  热门房源分页查询                
     	查询列表字段    热门排序  公寓ID，公寓名称，房源ID，房源编码，房源标题（名称），小区名称，户型（室厅卫）
   		查询条件 是否热门 公寓名称 房源标题（名称）房源编码 所在区域  -->
    <select id="getHotHouseList" resultType="com.apass.zufang.domain.vo.HouseVo"
    	parameterType="com.apass.zufang.domain.dto.HouseQueryParams">
    	<![CDATA[
        SELECT 
        	x.sort_no sortNo,
        	y.id apartmentid,y.name apartmentName,
        	x.id id,x.code houseCode,x.title title,
        	x.community_name communityName,x.room room,x.hall hall,x.wei wei
        FROM t_zfang_house x
       	LEFT JOIN t_zfang_apartment y on y.id = x.apartment_id
       	WHERE 1=1 
       	]]>
    	<if test="houseType!=null and houseType!=''"> AND x.type = #{houseType} </if>
    	<if test="apartmentName!=null and apartmentName!=''"> AND x.name = #{apartmentName} </if>
    	<if test="houseTitle!=null and houseTitle!=''"> AND x.title = #{houseTitle} </if>
    	<if test="houseCode!=null and houseCode!=''"> AND x.code = #{houseCode} </if>
    	<if test="houseArea!=null and houseArea!=''"> AND x.area = #{houseArea} </if>
    	<if test="isDelete!=null and isDelete!=''"> AND x.is_delete = #{isDelete} AND y.is_delete = #{isDelete}</if>
        <![CDATA[ 
        	ORDER BY x.type DESC,x.sort_no ASC,x.created_time DESC
       	]]>
        <if test="startRecordIndex != null">
            <include refid="PAGINATION.MYSQL_PAGINATION" />
        </if>
    </select>
    
    <!-- init城市 -->
    <select id="initCity" resultType="com.apass.zufang.domain.vo.HouseVo">
        <![CDATA[
        SELECT
			l.city
		FROM
			t_zfang_house h,
			t_zfang_house_location l
		WHERE
			h.id = l.house_id
		AND h.status = '3'
		AND h.is_delete = '00'
		GROUP BY l.city ASC
        ]]>
    </select>
    <!-- 查询房源List -->
    <select id="getHouseByCodes" parameterType="java.util.List" resultType="com.apass.zufang.domain.vo.HouseVo">
        <![CDATA[
        SELECT
				h.id			id,
				h.title			title,
				h.rent_amt		rentAmt,
				h.room			room,
				h.hall			hall,
				h.wei			wei,
				h.acreage		acreage,
				i.url			pictures,
				l.detail_addr	detailAddr
			FROM
				t_zfang_house h,
				t_zfang_house_img i,
				t_zfang_house_location l,
				t_zfang_apartment a
			WHERE
				h.id = i.house_id = l.house_id = a.house_id
				AND h.apartment_id = a.id
				AND h.status = '3'
				AND a.code in
        ]]>
        <foreach collection="list" item="employeeId" index="index" open="(" separator="," close=")">
				#{employeeId}
        </foreach>
        <![CDATA[
	      ORDER BY h.page_view DESC;
        ]]>
    </select>
    <!--电话预约管理 房源列表查询 
    	&查询列表字段     
    	公寓ID，公寓名称，小区名称，房源ID，房源标题（名称）,房源编码，房源状态，
    	所在城市，所在区域，所在街道，租金，户型（室厅卫），面积，是否独立厨、卫，
    	付款方式，出租类型
   		&查询条件 
   		公寓名称  小区名称 房源标题（名称）房源编码  所在城 区 街 房源状态 
   		面积 上下限 是否独立厨、卫，创建时间上下限
    -->
    <select id="getHouseListForPhoneAppointment" resultType="com.apass.zufang.domain.vo.HouseAppointmentVo" 
        parameterType="com.apass.zufang.domain.dto.HouseAppointmentQueryParams">
        <![CDATA[
        SELECT 
			y.id apartmentId,
			y.`name` apartmentName,
			y.`code` apartmentCode,
			x.id houseId,
			x.community_name communityName,
			x.title houseTitle,
			x.`code` houseCode,
			x.`status` houseStatus,
			z.province houseProvince,
			z.city houseCity,
			z.district houseDistrict,
			z.street houseStreet,
			z.detail_addr houseDetailAddr,
			x.rent_amt houseRentAmt,
			x.zujin_type houseZujinType,
			x.room houseRoom,
			x.hall houseHall,
			x.wei houseWei,
			x.rent_type houseRentType,
			x.acreage houseAcreage,
			x.room_acreage houseRoomAcreage,
			x.description houseDescription,
			x.hezu_resource houseHezuResource,
			x.chaoxiang houseChaoxiang,
			x.hezu_chaoxiang houseHezuChaoxiang
        FROM t_zfang_house_location z
			LEFT JOIN t_zfang_house x ON x.id = z.house_id  
        	LEFT JOIN t_zfang_apartment y ON y.id = x.apartment_id
        	LEFT JOIN t_zfang_house_peizhi a ON a.house_id = x.id
       	WHERE 1=1 
       	]]>
       	<if test="apartmentName!=null and apartmentName!=''"> AND y.`name` = #{apartmentName} </if>
       	<if test="communityName!=null and communityName!=''"> AND x.community_name = #{communityName} </if>
       	<if test="houseTitle!=null and houseTitle!=''"> AND x.title = #{houseTitle} </if>
       	<if test="houseCode!=null and houseCode!=''"> AND x.`code` = #{houseCode} </if>
       	<if test="houseCity!=null and houseCity!=''"> AND z.city = #{houseCity} </if>
       	<if test="houseDistrict!=null and houseDistrict!=''"> AND z.district = #{houseDistrict} </if>
       	<if test="houseStreet!=null and houseStreet!=''"> AND z.street = #{houseStreet} </if>
       	<if test="houseStatus!=null and houseStatus!=''"> AND x.`status` = #{houseStatus} </if>
       	AND CASE x.rent_type
       		WHEN '1' THEN 
       			<if test="houseAcreageFloor!=null and houseAcreageFloor!=''"> <![CDATA[ AND x.acreage >= #{houseAcreageFloor} ]]></if>
       			<if test="houseAcreageCeiling!=null and houseAcreageCeiling!=''"> <![CDATA[ AND x.acreage <= #{houseAcreageCeiling} ]]></if>
       		WHEN '2' THEN 
       			<if test="houseAcreageFloor!=null and houseAcreageFloor!=''"> <![CDATA[ AND x.room_acreage >= #{houseAcreageFloor} ]]></if>
       			<if test="houseAcreageCeiling!=null and houseAcreageCeiling!=''"> <![CDATA[ AND x.room_acreage <= #{houseAcreageCeiling} ]]></if>
       	ELSE '其他' END
       	<if test="houseCreatedFloor!=null and houseCreatedFloor!=''"> <![CDATA[ AND x.created_time >= #{houseCreatedFloor} ]]></if>
       	<if test="houseCreatedCeiling!=null and houseCreatedCeiling!=''"> <![CDATA[ AND x.created_time <= #{houseCreatedCeiling} ]]></if>
        <![CDATA[ 
        ORDER BY x.created_time DESC
        ]]>
        <if test="startRecordIndex != null">
            <include refid="PAGINATION.MYSQL_PAGINATION" />
        </if>
    </select>
</mapper>